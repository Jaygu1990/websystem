<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Five Doors — Pass/Fail</title>

<!-- Preload assets -->
<link rel="preload" as="image" href="/static/images/door.png" />
<link rel="preload" as="image" href="/static/images/pass.gif" />
<link rel="preload" as="image" href="/static/images/pokeball2.png" />
<link rel="preload" as="audio" href="/static/sounds/door.mp3" />

<style>
  :root{
    --bg:#0b0f14; --text:#e5e7eb; --muted:#9ca3af; --danger:#ef4444;
    --primary:#3b82f6;
    --accent:#22c55e;
    --ring: rgba(59,130,246,.45);

    --stage-pad: clamp(12px, 2.5vw, 28px);
    --door-gap: clamp(8px, 1.6vw, 22px);
    --radius: clamp(10px, 1.4vw, 16px);
    --door-radius: clamp(8px, 1vw, 12px);
    --panel-w: min(92vw, 1200px);
    --panel-h: min(70vh, 640px);
  }

  *{ box-sizing:border-box }
  html,body{ height:100%; margin:0 }

  body{
    font-family: system-ui, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    color:var(--text);
    background: url('/static/images/castle.png') center/cover no-repeat fixed;
    display:flex; flex-direction:column;
    min-height:100svh;
  }

  .app{
    width:100%;
    margin-inline:auto;
    display:flex; flex-direction:column;
    gap: clamp(8px, 1.2vw, 16px);
    padding: clamp(10px, 2vw, 20px);
  }

  header{
    display:flex; align-items:center; justify-content:space-between;
    gap: clamp(8px, 1.2vw, 16px); flex-wrap:wrap;
    max-width: var(--panel-w); margin-inline:auto;
  }

  h1{
    margin:0; font-weight:800; line-height:1.1;
    font-size: clamp(20px, 3.2vw, 32px);
    background:linear-gradient(180deg,#fff,#cbd5e1);
    -webkit-background-clip:text; background-clip:text; color:transparent;
    text-shadow: 0 1px 0 rgba(0,0,0,.2);
  }
  .sub{ display:block; font-size: clamp(12px, 1.6vw, 14px); color:var(--muted); font-weight:600; margin-top:4px; }

  .controls{ display:flex; gap: clamp(8px, 1vw, 12px); align-items:center; flex-wrap:wrap }
  .hint{ color:var(--muted); font-weight:600; font-size: clamp(12px, 1.6vw, 15px) }

  .btn{
    appearance:none; -webkit-appearance:none;
    background:linear-gradient(180deg, #1f2937, #111827);
    color:var(--text);
    border:1px solid #374151;
    padding: clamp(10px, 1.4vw, 14px) clamp(14px, 1.8vw, 20px);
    border-radius: clamp(10px, 1.2vw, 14px);
    font-weight:700; cursor:pointer;
    transition: transform .08s ease, background .2s ease, border-color .2s ease, box-shadow .2s ease, filter .2s ease;
    font-size: clamp(14px, 1.6vw, 16px);
    box-shadow: 0 6px 18px rgba(0,0,0,.35);
  }
  .btn:hover{ background:linear-gradient(180deg, #2a3447, #171c28); border-color:#4b5563; filter:brightness(1.05); }
  .btn:active{ transform:translateY(1px) }

  .btn-primary{ background:linear-gradient(180deg, #1e3a8a, #111827); border-color:#334155; }
  .btn-accent{ background:linear-gradient(180deg, #064e3b, #111827); border-color:#334155; }

  .stage{
    position:relative;
    background: rgba(0,0,0,.35);
    border:1px solid #1f2937; border-radius: var(--radius);
    padding: var(--stage-pad);
    box-shadow: inset 0 10px 30px rgba(0,0,0,.35);
    width: min(96vw, 1300px);
    margin-inline:auto;
    margin-top: 240px;

    display:grid;
    grid-template-rows: 1fr auto; 
    gap: var(--stage-pad);
    min-height: clamp(420px, 62svh, 78svh);
    overflow:hidden;
  }

  .doors{
    display:grid;
    grid-template-columns: repeat(5, minmax(0, 1fr));
    gap: var(--door-gap);
    align-items:center; justify-items:center;
    width:100%;
  }

  .door{
    position:relative;
    width: 100%;
    aspect-ratio: 2 / 3;
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(0,0,0,.38));
    border:none; border-radius: var(--door-radius);
    box-shadow: 0 6px 18px rgba(0,0,0,.55), inset 0 0 0 2px rgba(255,255,255,.14);
    cursor:pointer;
  }
  .door::after{
    content:""; position:absolute; right:10%; top:50%;
    width: clamp(10px, 1.1vw, 16px); height: clamp(10px, 1.1vw, 16px);
    border-radius:50%;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.85), rgba(255,215,0,.95) 40%, rgba(90,60,10,.92) 75%);
    box-shadow: 0 0 8px rgba(255,215,0,.4), inset 0 0 2px rgba(0,0,0,.55);
    transform: translateY(-50%);
  }
  .door:hover{ filter:brightness(1.12); }

  .door .redx{
    position:absolute; inset:0;
    display:none; align-items:center; justify-content:center;
    background: rgba(0,0,0,.35);
    z-index: 5; pointer-events:none;
    border-radius: var(--door-radius);
  }
  .door .redx::before, .door .redx::after{
    content:""; position:absolute; width:80%; height: clamp(8px, .9vw, 12px);
    background:var(--danger); border-radius:10px;
    box-shadow: 0 0 18px rgba(239,68,68,.6);
  }
  .door .redx::before{ transform:rotate(45deg) }
  .door .redx::after{ transform:rotate(-45deg) }

  .overlay {
    position:absolute; inset:0; display:none;
    align-items:center; justify-content:center;
    background: transparent;
    z-index:30;
  }
  .overlay.show{ display:flex }
  .overlay .panel{
    background: transparent; border:none; box-shadow:none;
    padding:0; width:auto;
    max-height: var(--panel-h);
    display:flex; align-items:center; justify-content:center;
  }
  .overlay img{ max-width:100%; max-height: calc(var(--panel-h) - 24px); display:block }

  /* Balls grid (fixed 10x3 slots) */
  .balls{
    display:grid;
    grid-template-columns: repeat(10, 1fr);
    grid-template-rows: repeat(3, auto);
    gap: 6px;
    justify-items:center; align-items:center;
    padding: 10px;
    background: linear-gradient(180deg, transparent, rgba(0,0,0,.45));
    border-radius: calc(var(--radius) - 4px);
  }
  .balls img{
    height: clamp(40px, 6vh, 64px);
    width:auto;
    opacity:0.15; /* empty slot faint placeholder */
    transition: opacity .2s ease;
  }
  .balls img.filled{
    opacity:1; /* when filled */
  }
</style>
</head>
<body>
  <div class="app" role="application" aria-label="Five Doors Game">
    <header>
      <div>
        <h1>Five Doors — Pass or Fail</h1>
        <span class="sub">Four doors pass, one door fails — each pick is random.</span>
      </div>
      <div class="controls">
        <button id="resetBtn" class="btn btn-accent">Reset</button>
        <button id="flipBtn" class="btn btn-primary">Go to Flip Game</button>
        <span class="hint" id="statusHint" aria-live="polite">Choose a door.</span>
      </div>
    </header>

    <section class="stage" id="stage" aria-live="polite">
      <div class="doors" id="doorsRow" aria-label="Doors"></div>

      <div class="overlay" id="overlay">
        <div class="panel"><img id="overlayImg" alt="Pass" /></div>
      </div>

      <!-- Pre-built 10×3 Pokéball slots -->
      <div class="balls" id="ballsStrip"></div>
    </section>
  </div>

<script>
(() => {
  const IMG = '/static/images/';
  const SND = '/static/sounds/';
  const DOOR_COUNT = 5;
  const MAX_SLOTS = 30;

  const ASSETS = {
    pass: IMG + 'pass.gif',
    ball: IMG + 'pokeball2.png',
    doorSfx: SND + 'door.mp3'
  };

  const doorsRow   = document.getElementById('doorsRow');
  const overlay    = document.getElementById('overlay');
  const overlayImg = document.getElementById('overlayImg');
  const ballsStrip = document.getElementById('ballsStrip');
  const statusHint = document.getElementById('statusHint');
  const resetBtn   = document.getElementById('resetBtn');
  const btnFlip    = document.getElementById('flipBtn');

  let failIndex = -1;
  let gameOver  = false;
  let passCount = 0;
  let ballSlots = [];

  // build ball slots once
  function buildBallSlots(){
    ballsStrip.innerHTML = "";
    ballSlots = [];
    for(let i=0;i<MAX_SLOTS;i++){
      const img = document.createElement("img");
      img.src = ASSETS.ball;
      img.alt = "Pokéball";
      ballsStrip.appendChild(img);
      ballSlots.push(img);
    }
  }

  // Audio
  const sfxDoorBase = new Audio(ASSETS.doorSfx);
  sfxDoorBase.preload = 'auto';
  sfxDoorBase.volume = 0.9;
  let audioUnlocked = false;
  function unlockAudioOnce() {
    if (audioUnlocked) return;
    try {
      sfxDoorBase.play().then(() => {
        sfxDoorBase.pause();
        sfxDoorBase.currentTime = 0;
        audioUnlocked = true;
      }).catch(()=>{});
    } catch(_) {}
  }
  function playDoor() {
    try {
      const a = sfxDoorBase.cloneNode();
      a.volume = sfxDoorBase.volume;
      a.play().catch(()=>{});
    } catch(_) {}
  }

  // Build doors
  const doors = [];
  for (let i = 0; i < DOOR_COUNT; i++) {
    const d = document.createElement('button');
    d.className = 'door';
    d.setAttribute('aria-label', `Door ${i+1}`);
    d.dataset.index = String(i);

    const x = document.createElement('div');
    x.className = 'redx';
    d.appendChild(x);

    d.addEventListener('pointerdown', unlockAudioOnce, { once: true });
    d.addEventListener('click', onDoorClick);
    doorsRow.appendChild(d);
    doors.push(d);
  }

  [ASSETS.pass, ASSETS.ball].forEach(src => { const im = new Image(); im.src = src; });

  resetBtn.addEventListener('click', resetRun);
  resetBtn.addEventListener('pointerdown', unlockAudioOnce, { once: true });
  overlay.addEventListener('click', clearOverlay);
  btnFlip.addEventListener('click', () => { window.location.href = location.origin + '/flipgame'; });

  resetRun();

  function clearOverlay(){
    overlay.classList.remove('show');
    overlayImg.removeAttribute('src');
  }
  function showPassOverlay(){
    clearOverlay();
    overlayImg.src = ASSETS.pass + '?t=' + Date.now();
    overlay.classList.add('show');
  }

  function addBall(){
    if(passCount<=MAX_SLOTS){
      ballSlots[passCount-1].classList.add("filled");
    }
  }

  function rerollFail(){
    failIndex = Math.floor(Math.random() * DOOR_COUNT);
  }

  function resetRun(){
    gameOver = false;
    passCount = 0;
    clearOverlay();
    statusHint.textContent = 'Choose a door. Survive as many rounds as you can!';
    doors.forEach(d => { d.disabled=false; d.querySelector('.redx').style.display='none'; });
    rerollFail();
    buildBallSlots();
  }

  function onDoorClick(e){
    clearOverlay();
    playDoor();
    if (gameOver) return;
    const idx = Number(e.currentTarget.dataset.index);
    doors.forEach(d => d.disabled = true);

    if (idx === failIndex) {
      e.currentTarget.querySelector('.redx').style.display = 'flex';
      statusHint.textContent = `Fail at door ${idx+1}. You passed ${passCount} round${passCount===1?'':'s'}. Press Reset to try again.`;
      gameOver = true;
      return;
    }

    passCount++;
    addBall();
    showPassOverlay();
    statusHint.textContent = `Pass #${passCount}! Pick again.`;
    rerollFail();
    doors.forEach(d => d.disabled = false);
  }
})();
</script>
</body>
</html>
